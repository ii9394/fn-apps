#!/bin/bash

LOG_FILE="${TRIM_PKGVAR}/info.log"
PID_FILE="${TRIM_PKGVAR}/app.pid"
SOCKET_FILE="${TRIM_PKGVAR}/led.sock"
CONFIG_FILE="${TRIM_PKGVAR}/config.json"

# Python LED控制服务
PYTHON_BIN="python3"
LED_SCRIPT="${TRIM_APPDEST}/server/led_control.py"

log_msg() {
  echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >>${LOG_FILE}
}

start_process() {
  if status; then
    return 0
  fi

  log_msg "Starting LED control service..."
  
  # 确保脚本可执行
  chmod +x "${TRIM_APPDEST}/server/ugreen_leds_cli" 2>/dev/null
  chmod +x "${LED_SCRIPT}" 2>/dev/null
  
  # 启动 Python 服务（带 Unix socket 支持 API）
  ${PYTHON_BIN} "${LED_SCRIPT}" --unix-socket "${SOCKET_FILE}" --config "${CONFIG_FILE}" >>${LOG_FILE} 2>&1 &
  printf "%s" "$!" >${PID_FILE}
  
  log_msg "LED control service started, PID: $!"
  return 0
}

stop_process() {
  log_msg "Stopping LED control service..."

  if [ -r "${PID_FILE}" ]; then
    pid=$(head -n 1 "${PID_FILE}" | tr -d '[:space:]')

    log_msg "Main PID: ${pid}"
    if ! check_process "${pid}"; then
      rm -f "${PID_FILE}"
      log_msg "PID file removed (process not exist)"
      return
    fi

    log_msg "Sending TERM signal to PID:${pid}..."
    kill -TERM ${pid} >>${LOG_FILE} 2>&1

    local count=0
    while check_process "${pid}" && [ $count -lt 30 ]; do
      sleep 1
      count=$((count + 1))
      log_msg "Waiting for process to terminate... (${count}s/30s)"
    done

    if check_process "${pid}"; then
      log_msg "Sending KILL signal to PID:${pid}..."
      kill -KILL "${pid}"
      sleep 1
    fi
    
    rm -f "${PID_FILE}"
    rm -f "${SOCKET_FILE}"
    log_msg "LED control service stopped"
  fi

  return 0
}

check_process() {
  local pid=$1
  if kill -0 "${pid}" 2>/dev/null; then
    return 0
  else
    return 1
  fi
}

status() {
  if [ -f "${PID_FILE}" ]; then
    pid=$(head -n 1 "${PID_FILE}" | tr -d '[:space:]')
    if check_process "${pid}"; then
      return 0
    else
      rm -f "${PID_FILE}"
    fi
  fi

  return 1
}

case $1 in
  start)
    start_process
    ;;
  stop)
    stop_process
    ;;
  status)
    if status; then
      exit 0
    else
      exit 3
    fi
    ;;
  *)
    exit 1
    ;;
esac
